name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GCP_REGISTRY_DOMAIN: ${{ secrets.GCP_REGISTRY_DOMAIN }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REPO_NAME: ${{ secrets.GCP_REPO_NAME }}
  IMAGE_TAG: ${{ github.sha }}
  TOKEN: ${{ secrets.GITLAB_TOKEN }}
  REPO_PATH: ${{ secrets.GITLAB_REPO_PATH }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run Maven tests and package JARs
        run: |
          set -e
          for service in user-service recipe-service; do
            cd backend/$service
            mvn clean package -DskipTests=false
            echo "=== Listing JARs for $service ==="
            ls -lh target/*.jar || echo "❌ JAR not found for $service"
            cd ../../
          done

      - name: Authenticate to Google Cloud
        if: github.ref == 'refs/heads/main'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker to use Artifact Registry
        if: github.ref == 'refs/heads/main'
        run: |
          gcloud auth configure-docker $GCP_REGISTRY_DOMAIN

      - name: Docker Build & Push (Backend)
        if: github.ref == 'refs/heads/main'
        run: |
          FULL_REPO="$GCP_REGISTRY_DOMAIN/$GCP_PROJECT_ID/$GCP_REPO_NAME"
          for service in user-service recipe-service; do
            cd backend/$service
            docker build -t $FULL_REPO/$service:$IMAGE_TAG .
            docker push $FULL_REPO/$service:$IMAGE_TAG
            cd ../../
          done
          
      - name: Docker Build & Push (Frontend)
        if: github.ref == 'refs/heads/main'
        run: |
          FULL_REPO="$GCP_REGISTRY_DOMAIN/$GCP_PROJECT_ID/$GCP_REPO_NAME"
          docker build -t $FULL_REPO/frontend:$IMAGE_TAG -f Dockerfile.frontend .
          docker push $FULL_REPO/frontend:$IMAGE_TAG
          
      - name: Update Helm values in GitLab (Backend & Frontend)
        if: github.ref == 'refs/heads/main'
        run: |
          git config --global user.name "GitHub CI Bot"
          git config --global user.email "ci-bot@example.com"
          
          # Clone GitLab Helm repo
          git clone "https://oauth2:${TOKEN}@gitlab.com/${REPO_PATH}" helm-repo
          cd helm-repo/my-helm-chart

          # values.yaml에서 태그 치환 (모든 서비스)
          sed -i "s|\(userService.*tag:\).*|\1 ${IMAGE_TAG}|" values.yaml
          sed -i "s|\(recipeService.*tag:\).*|\1 ${IMAGE_TAG}|" values.yaml
          sed -i "s|\(frontendService.*tag:\).*|\1 ${IMAGE_TAG}|" values.yaml

          cd ..
          git add my-helm-chart/values.yaml
          git commit -m "ci: update image tag to $IMAGE_TAG"
          git push origin main

